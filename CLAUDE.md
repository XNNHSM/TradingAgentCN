# CLAUDE.md

本文件为 Claude Code (claude.ai/code) 在此仓库中工作时提供指导。

## 🏗️ 系统架构概述

TradingAgentCN 是一个基于大语言模型(LLM)的智能交易决策系统，专门针对中国A股市场设计。系统通过多智能体协作、实时数据采集、情绪分析和技术指标分析，为投资者提供专业的交易建议和风险评估。

### 技术栈
- **后端框架**: NestJS + TypeScript + TypeORM
- **智能体框架**: LangChain.js
- **主要LLM**: 阿里云百炼(DashScope)
- **数据库**: MySQL + Redis
- **部署方案**: Docker 容器化

### 系统架构
```
API接口层 → NestJS服务层 → 多智能体框架 → LLM提供商层 → 数据服务层 → 存储缓存层
```

### 核心组件
1. **自选股管理**: 股票选择、持仓跟踪
2. **多智能体决策引擎**: 市场分析师、基本面分析师、新闻分析师、研究员、交易员
3. **数据采集**: 股票数据、财务数据、新闻情绪、社交媒体
4. **风险管理**: 内置风险控制和反思机制

## 🚀 开发命令

### 构建和启动
```bash
# 构建应用
npm run build

# 开发模式(热重载)
npm run start:dev

# 调试模式
npm run start:debug

# 生产模式
npm run start:prod
```

### 测试
```bash
# 运行所有测试
npm run test

# 监听模式运行测试
npm run test:watch

# 运行测试并生成覆盖率报告
npm run test:cov

# 运行端到端测试
npm run test:e2e

# 调试测试
npm run test:debug
```

### 代码质量
```bash
# ESLint 检查和自动修复
npm run lint

# Prettier 代码格式化
npm run format
```

### 数据库管理
```bash
# 生成数据库迁移文件
npm run migration:generate

# 执行数据库迁移
npm run migration:run

# 回滚数据库迁移
npm run migration:revert
```

### Docker 部署
```bash
# 使用 Docker Compose 启动
docker-compose up -d

# 手动构建 Docker 镜像
docker build -t trading-agent-cn .
```

## 📁 项目结构

```
src/
├── agents/                 # 智能体模块(待实现)
├── app.module.ts          # 主应用模块
├── main.ts               # 应用入口点
├── common/               # 公共工具和组件
│   ├── decorators/       # 自定义装饰器
│   ├── dto/             # 数据传输对象
│   │   └── result.dto.ts # 统一响应格式
│   ├── entities/        # 基础实体类
│   │   └── base.entity.ts # 通用字段基础实体
│   ├── enums/           # 枚举定义
│   ├── filters/         # 异常过滤器
│   ├── guards/          # 认证/授权守卫
│   ├── interceptors/    # 请求/响应拦截器
│   ├── pipes/           # 验证管道
│   └── utils/           # 工具函数
├── config/              # 配置文件
│   ├── database.config.ts # 数据库配置
│   └── redis.config.ts   # Redis配置
└── modules/             # 业务模块
    ├── health/          # 健康检查模块
    │   ├── health.controller.ts
    │   ├── health.module.ts
    │   └── health.service.ts
    ├── user/            # 用户管理(待实现)
    └── watchlist/       # 自选股管理
        ├── dto/         # 自选股DTOs
        ├── entities/    # 自选股实体
        ├── watchlist.controller.ts
        ├── watchlist.module.ts
        └── watchlist.service.ts
```

## 🗄️ 数据库架构

### 存储架构
```
┌─────────────────────────────────────────────────────────────────┐
│                          数据存储架构                           │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Redis 缓存层                            │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │ │
│  │  │实时数据缓存 │ │计算结果缓存 │ │会话缓存     │          │ │
│  │  │- 股票价格   │ │- 智能体分析 │ │- 用户状态   │          │ │
│  │  │- 新闻数据   │ │- 技术指标   │ │- 临时数据   │          │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │ (仅缓存，所有数据必须落盘)         │
│                              ▼                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                   MySQL 持久化存储                         │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │ │
│  │  │核心业务数据 │ │股票市场数据 │ │系统运营数据 │          │ │
│  │  │- 用户信息   │ │- 股票基础   │ │- 系统配置   │          │ │
│  │  │- 自选股     │ │- 价格数据   │ │- 操作日志   │          │ │
│  │  │- 持仓信息   │ │- 技术指标   │ │- 错误日志   │          │ │
│  │  │- 决策记录   │ │- 新闻数据   │ │- 监控数据   │          │ │
│  │  │- 分析结果   │ │- 情绪分析   │ │             │          │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘          │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 存储策略
- **MySQL**: 所有业务数据的主要持久化存储，包含核心业务数据、股票市场数据和系统运营数据
- **Redis**: 仅作为缓存层 - 所有数据必须落盘到MySQL，包含实时数据缓存、计算结果缓存和会话缓存
- **软删除**: 所有实体使用逻辑删除(deletedAt字段)

### 实体标准
- 所有实体继承 `BaseEntity`，包含标准字段:
  - `createdAt`: 创建时间戳
  - `updatedAt`: 更新时间戳
  - `deletedAt`: 删除时间戳(软删除)
  - `version`: 乐观锁版本号

### 查询限制
- 每个查询最多关联3张表
- 所有列表接口必须实现分页(最多200条记录)
- 避免可能导致全表扫描的复杂查询
- 禁止跨模块联表查询，由相应模块service提供方法进行数据聚合
- 禁止跨模块直接注入repository

### 缓存命名规范
- 模式: `模块:方法:参数`
- 示例: `watchlist:list:userId123`
- 所有缓存键必须设置TTL过期时间

### 数据流向设计

#### 数据写入流程
```
1. 数据源 → 2. 业务处理 → 3. MySQL落盘 → 4. Redis缓存
```

#### 数据读取流程
```
1. 查询Redis缓存 → 2. 缓存命中返回 → 3. 缓存未命中查MySQL → 4. 回写Redis
```

## 🔧 API 标准

### 请求格式
- **所有接口统一使用POST方法** (不使用GET/PUT/DELETE)
- **所有参数放在请求体中** (不使用URL参数或查询字符串)
- Content-Type: `application/json`

### 响应格式
所有API返回标准化的 `Result<T>` 格式:
```typescript
{
  code: number,    // 0 = 成功，非零 = 错误
  data: T,         // 响应数据
  message: string, // 响应消息
  timestamp: string // 响应时间戳
}
```

### 分页格式
```typescript
{
  code: 0,
  data: {
    items: T[],           // 当前页数据
    total: number,        // 总记录数
    page: number,         // 当前页码(从1开始)
    limit: number,        // 每页大小
    totalPages: number,   // 总页数
    hasNext: boolean,     // 是否有下一页
    hasPrev: boolean      // 是否有上一页
  }
}
```

## 🎯 多智能体系统(规划中)

### 智能体层次结构
```
交易智能体系统/
├── 分析师团队
│   ├── 市场分析师(技术分析)
│   ├── 基本面分析师(财务分析)
│   └── 新闻分析师(情绪分析)
├── 研究团队
│   ├── 多头研究员(乐观观点)
│   └── 空头研究员(风险分析)
├── 交易团队
│   ├── 交易智能体(决策制定)
│   └── 风险管理员(风险评估)
└── 反思系统
    └── 反思智能体(质量控制)
```

### 决策工作流

#### 自动流程(定时任务)
1. 每天早上9点启动定时任务
2. 检查是否为交易日，非交易日结束流程
3. 获取已添加的自选股列表
4. 根据自选股获取近期股票数据、财务数据
5. 获取近期经济和国际相关新闻
6. 多智能体协作进行决策分析
7. 形成当日的买卖建议

#### 手动分析流程
1. 接收HTTP请求，用户输入股票代码
2. 验证股票代码格式和有效性
3. 获取指定股票的数据和财务信息
4. 获取近期经济和国际相关新闻
5. 触发多智能体决策分析
6. 返回实时的买卖建议

## 🌐 数据源

### 股票市场数据
- **上海证券交易所**: 60xxxx 代码
- **深圳证券交易所**: 00xxxx 代码
- **创业板**: 30xxxx 代码
- **科创板**: 68xxxx 代码

### 外部API
- **股票数据API**: 通达信API(A股数据)
- **财经新闻API**: 新浪、网易等财经媒体
- **宏观经济API**: 央行、国家统计局数据
- **社交媒体API**: 微博、雪球等平台情绪数据

### LLM提供商
- **主要提供商**: 阿里云百炼(DashScope)
  - 模型: qwen-turbo, qwen-plus, qwen-max等
  - 中文语言优化，中国用户首选
- **备选方案**: OpenAI GPT、Google Gemini、Anthropic Claude

## 🔒 开发指南

### 代码标准
- 使用TypeScript严格类型检查
- 遵循NestJS模块结构和依赖注入
- 实现适当的错误处理和日志记录
- 使用DTOs配合 `class-validator` 进行输入验证

### 安全最佳实践
- 永远不要在代码中暴露API密钥或机密信息
- 使用环境变量进行配置
- 实现适当的身份验证和授权
- 验证所有输入数据

### 模块设计
- 每个模块应该是自包含的
- 避免跨模块直接注入repository
- 使用服务间通信进行跨模块数据访问
- 遵循领域驱动设计原则

## 🚀 快速开始

1. **安装依赖**: `npm install`
2. **配置环境**: 复制 `.env.example` 到 `.env` 并配置
3. **启动数据库**: 确保MySQL和Redis正在运行
4. **运行开发模式**: `npm run start:dev`
5. **访问API文档**: http://localhost:3000/api-docs
6. **运行测试**: `npm run test`

## 🏗️ 详细架构图

### 整体系统架构
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         API 接口层 (API Gateway)                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │  RESTful APIs   │  │  WebSocket APIs │  │   定时任务接口   │              │
│  │ (CRUD操作)      │  │ (实时推送)      │  │  (系统调度)     │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────────────────┐
│                    NestJS 后端服务层 (Application Layer)                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                         业务服务模块                                    │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │ │
│  │  │自选股服务   │ │决策引擎服务 │ │数据采集服务 │ │新闻分析服务 │      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘      │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │ │
│  │  │风险管控服务 │ │定时任务服务 │ │通知推送服务 │ │系统配置服务 │      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘      │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                      TypeORM 数据访问层                                │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │ │
│  │  │实体模型     │ │仓储模式     │ │数据验证     │ │事务管理     │      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘      │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
┌─────────────────────────────────────────────────────────────────────────────┐
│                    多智能体框架层 (LangChain.js Agents)                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                         智能体协作系统                                  │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                      │ │
│  │  │市场分析师   │ │基本面分析师 │ │新闻分析师   │                      │ │
│  │  │(技术分析)   │ │(财务分析)   │ │(情绪分析)   │                      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘                      │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                      │ │
│  │  │多头研究员   │ │空头研究员   │ │交易员智能体 │                      │ │
│  │  │(积极情绪)   │ │(风险分析)   │ │(决策制定)   │                      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘                      │ │
│  │  ┌─────────────┐ ┌─────────────┐                                      │ │
│  │  │风险管理员   │ │反思智能体   │                                      │ │
│  │  │(风险评估)   │ │(质量控制)   │                                      │ │
│  │  └─────────────┘ └─────────────┘                                      │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 📝 业务模块设计

### 1. 自选股模块
- **添加自选股**: 验证股票代码，存储股票信息
- **获取自选股列表**: 支持分页，返回用户的所有自选股
- **更新自选股**: 修改持仓信息，包括数量和价格
- **删除自选股**: 逻辑删除，保留历史记录

**自选股信息字段**:
- 股票代码(stockCode)
- 股票名称(stockName)  
- 是否持仓(isHolding)
- 持仓数量(holdingQuantity)
- 持仓价格(holdingPrice)

### 2. 智能体决策模块
- **数据收集**: 获取股票数据、财务数据、新闻数据
- **多智能体协作**: 分析师团队、研究团队、交易团队协作
- **决策生成**: 基于多角度分析生成买卖建议
- **结果存储**: 持久化决策过程和结果

### 3. 数据获取模块

#### 股市信息获取
- 实时股票价格数据
- 历史价格和成交量
- 技术指标计算
- 财务报表数据

#### 新闻信息获取
- **公共新闻**: 国际、国内经济形势新闻
- **个股新闻**: 行业动态、公司公告、舆论信息
- **情绪分析**: 新闻情绪量化分析
- **多数据源适配**: 工厂模式设计，支持多个新闻源

## 📝 关键文件
- `src/main.ts`: 应用启动入口
- `src/app.module.ts`: 根模块配置
- `src/common/entities/base.entity.ts`: 包含标准字段的基础实体
- `src/common/dto/result.dto.ts`: 标准化API响应格式
- `prompt_templates.md`: AI智能体提示词模板